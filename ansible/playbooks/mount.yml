---
# å®‰å…¨ã€å¹‚ç­‰çš„æ•°æ®ç›˜æŒ‚è½½ Playbook
# éµå¾ªæœ€ä½³å®è·µï¼šå¤šé‡éªŒè¯ã€æ•°æ®ä¿æŠ¤ã€çœŸæ­£çš„å¹‚ç­‰æ€§
#
# è®¾è®¡åŸåˆ™ï¼š
# 1. å¦‚æœ /data å·²æ­£ç¡®æŒ‚è½½ â†’ å®Œå…¨è·³è¿‡ï¼ˆSUCCESSï¼‰
# 2. å¦‚æœ /data åœ¨ fstab ä½†æœªæŒ‚è½½ â†’ åªæ‰§è¡Œ mountï¼ˆä¸ä¿®æ”¹é…ç½®ï¼‰
# 3. å¦‚æœ /data å®Œå…¨æœªé…ç½® â†’ æ‰§è¡Œå®Œæ•´æŒ‚è½½æµç¨‹
# 4. æ°¸ä¸ç ´åå·²æœ‰çš„æ­£ç¡®é…ç½®å’Œæ•°æ®
#
# å˜é‡:
#   use_data_volume: true  â†’ æŒ‚è½½ç‹¬ç«‹æ•°æ®ç›˜åˆ° /data
#   use_data_volume: false â†’ ä»…åˆ›å»º /data ç›®å½•ï¼ˆä½¿ç”¨ç³»ç»Ÿç›˜ï¼‰

# ========================================
# æ— æŒ‚è½½æ¨¡å¼ï¼šä»…åˆ›å»º /data ç›®å½•
# ========================================
- name: Create /data directory (no volume mount)
  hosts: all
  become: yes
  gather_facts: no

  tasks:
    - name: Create /data directory on system disk
      file:
        path: /data
        state: directory
        owner: "{{ deploy_user | default('deploy') }}"
        group: "{{ deploy_user | default('deploy') }}"
        mode: '0755'
      when: not (use_data_volume | default(true))

    - name: Display no-mount mode message
      debug:
        msg:
          - "âœ… /data directory created on system disk"
          - "   (use_data_volume=false, no volume mounted)"
      when: not (use_data_volume | default(true))

    - name: End play for this host (no mount mode)
      meta: end_host
      when: not (use_data_volume | default(true))

# ========================================
# æŒ‚è½½æ¨¡å¼ï¼šæŒ‚è½½ç‹¬ç«‹æ•°æ®ç›˜
# ========================================
- name: Setup Data Storage Mount (Safe & Idempotent)
  hosts: all
  become: yes
  any_errors_fatal: true  # ä»»ä½•ä¸»æœºå¤±è´¥éƒ½åœæ­¢æ•´ä¸ª playbook
  vars:
    data_mount_point: "/data"
    data_disk_min_size_gb: 10  # æœ€å°ç£ç›˜å¤§å°ï¼ˆé¿å…é€‰æ‹©å¤ªå°çš„è®¾å¤‡ï¼‰

  tasks:
    # ========================================
    # è·³è¿‡æ¡ä»¶ï¼šå¦‚æœ use_data_volume=falseï¼Œä¸æ‰§è¡ŒæŒ‚è½½
    # ========================================
    - name: "Skip mount play if use_data_volume is false"
      meta: end_host
      when: not (use_data_volume | default(true))

    # ========================================
    # é˜¶æ®µ 1: å¤šé‡éªŒè¯ - æ£€æŸ¥ /data æ˜¯å¦å·²æ­£ç¡®æŒ‚è½½
    # ========================================
    - name: "Phase 1: Check if /data is already mounted (mountpoint)"
      command: mountpoint -q "{{ data_mount_point }}"
      register: is_mountpoint
      failed_when: false
      changed_when: false

    - name: "Phase 1: Verify /data is accessible (df)"
      command: df "{{ data_mount_point }}"
      register: df_check
      failed_when: false
      changed_when: false
      when: is_mountpoint.rc == 0

    - name: "Phase 1: Check /proc/mounts"
      shell: grep -q " {{ data_mount_point }} " /proc/mounts
      register: in_proc_mounts
      failed_when: false
      changed_when: false

    - name: "Phase 1: Check /etc/fstab"
      shell: grep -v "^#" /etc/fstab | grep -q " {{ data_mount_point }} "
      register: in_fstab
      failed_when: false
      changed_when: false

    - name: "Phase 1: Get current mount info"
      shell: mount | grep " {{ data_mount_point }} " || echo "not mounted"
      register: current_mount_info
      changed_when: false

    - name: "Phase 1: Display mount status"
      debug:
        msg:
          - "====== /data Mount Status ======"
          - "Is mountpoint: {{ is_mountpoint.rc == 0 }}"
          - "Accessible (df): {{ df_check.rc == 0 if is_mountpoint.rc == 0 else 'N/A' }}"
          - "In /proc/mounts: {{ in_proc_mounts.rc == 0 }}"
          - "In /etc/fstab: {{ in_fstab.rc == 0 }}"
          - "Current mount: {{ current_mount_info.stdout }}"
          - "================================"

    # ========================================
    # å†³ç­–ç‚¹ 1: å¦‚æœå·²æ­£ç¡®æŒ‚è½½ä¸”å¥åº· â†’ å®Œå…¨è·³è¿‡
    # ========================================
    - name: "Decision 1: Skip if /data is already healthy"
      when: is_mountpoint.rc == 0 and df_check.rc == 0
      block:
        - name: Display success message
          debug:
            msg:
              - "âœ… /data is already mounted and healthy!"
              - "{{ df_check.stdout_lines | join('\n') }}"
              - ""
              - "Skipping all mount operations (idempotent behavior)."

        - name: End play for this host
          meta: end_host

    # ========================================
    # å†³ç­–ç‚¹ 2: å¦‚æœåœ¨ fstab ä½†æœªæŒ‚è½½ â†’ åªæ‰§è¡Œ mount
    # ========================================
    - name: "Decision 2: Mount from fstab if configured but not mounted"
      when:
        - is_mountpoint.rc != 0  # æœªæŒ‚è½½
        - in_fstab.rc == 0        # ä½†åœ¨ fstab ä¸­
      block:
        - name: Get fstab entry for /data
          shell: grep -v "^#" /etc/fstab | grep " {{ data_mount_point }} "
          register: fstab_entry
          changed_when: false

        - name: Display fstab entry
          debug:
            msg:
              - "âš ï¸  /data is configured in fstab but not mounted"
              - "fstab entry: {{ fstab_entry.stdout }}"
              - "Attempting to mount..."

        - name: Create mount point directory if missing
          file:
            path: "{{ data_mount_point }}"
            state: directory
            mode: '0755'

        - name: Mount using fstab configuration
          command: mount "{{ data_mount_point }}"
          register: mount_from_fstab

        - name: Verify mount succeeded
          command: df -h "{{ data_mount_point }}"
          register: df_verify
          changed_when: false

        - name: Display success
          debug:
            msg:
              - "âœ… Successfully mounted /data using existing fstab configuration"
              - "{{ df_verify.stdout }}"

        - name: Set ownership
          file:
            path: "{{ data_mount_point }}"
            owner: "{{ deploy_user | default('deploy') }}"
            group: "{{ deploy_user | default('deploy') }}"
            mode: '0755'

        - name: End play for this host
          meta: end_host

    # ========================================
    # å†³ç­–ç‚¹ 3: å®Œå…¨æœªé…ç½® â†’ æ‰§è¡Œå®Œæ•´æŒ‚è½½æµç¨‹
    # ========================================
    - name: "Decision 3: Full mount setup (not configured)"
      when:
        - is_mountpoint.rc != 0  # æœªæŒ‚è½½
        - in_fstab.rc != 0        # ä¸”ä¸åœ¨ fstab ä¸­
      block:
        # ========================================
        # 3.1 æ•°æ®å®‰å…¨æ£€æŸ¥
        # ========================================
        - name: Check if /data directory exists and has content
          find:
            paths: "{{ data_mount_point }}"
            file_type: any
          register: data_dir_contents
          when: false  # æš‚æ—¶ç¦ç”¨ï¼Œå› ä¸ºå¯èƒ½ /data ä¸å­˜åœ¨

        - name: Check if /data exists
          stat:
            path: "{{ data_mount_point }}"
          register: data_dir_stat

        - name: Count files in /data if it exists
          shell: find "{{ data_mount_point }}" -mindepth 1 -maxdepth 1 | wc -l
          register: data_file_count
          changed_when: false
          when: data_dir_stat.stat.exists and data_dir_stat.stat.isdir

        - name: Warn if /data has content
          fail:
            msg: |
              âš ï¸  WARNING: /data directory exists and contains {{ data_file_count.stdout }} items!

              This playbook will mount a disk to /data, which may hide existing files.

              To proceed:
              1. Backup /data contents: sudo tar czf /tmp/data-backup.tar.gz /data
              2. Re-run with: -e force_mount_over_data=true

              Or manually move the files and re-run this playbook.
          when:
            - data_dir_stat.stat.exists
            - data_dir_stat.stat.isdir
            - data_file_count.stdout | int > 0
            - not (force_mount_over_data | default(false))

        # ========================================
        # 3.2 ç£ç›˜æ£€æµ‹
        # ========================================
        - name: Get all block devices
          command: lsblk -J -b -o NAME,SIZE,TYPE,MOUNTPOINT,FSTYPE
          register: lsblk_output
          changed_when: false

        - name: Parse devices
          set_fact:
            all_devices: "{{ (lsblk_output.stdout | from_json).blockdevices }}"

        - name: Find data disk candidates (disks)
          set_fact:
            disk_candidates: >-
              {{
                all_devices |
                selectattr('type', 'equalto', 'disk') |
                rejectattr('name', 'match', '^(sr|loop).*') |
                rejectattr('size', 'equalto', 0) |
                list
              }}

        - name: Find partition candidates from data disks
          set_fact:
            partition_candidates: >-
              {{
                disk_candidates |
                selectattr('children', 'defined') |
                map(attribute='children') |
                flatten |
                selectattr('type', 'equalto', 'part') |
                rejectattr('mountpoint', 'equalto', '/') |
                rejectattr('mountpoint', 'match', '^/boot') |
                rejectattr('fstype', 'none') |
                list
              }}

        - name: Debug - Show disk candidates
          debug:
            msg: "Disk {{ item.name }}: {{ (item.size | int / 1073741824) | round(1) }}GB, mountpoint={{ item.mountpoint | default('none') }}, fstype={{ item.fstype | default('none') }}"
          loop: "{{ disk_candidates }}"
          when: disk_candidates | length > 0

        - name: Debug - Show partition candidates
          debug:
            msg: "Partition {{ item.name }}: {{ (item.size | int / 1073741824) | round(1) }}GB, mountpoint={{ item.mountpoint | default('none') }}, fstype={{ item.fstype | default('none') }}"
          loop: "{{ partition_candidates }}"
          when: partition_candidates | length > 0

        # ========================================
        # 3.3 æ™ºèƒ½é€‰æ‹©è®¾å¤‡ï¼ˆä¼˜å…ˆåˆ†åŒºï¼Œå…¶æ¬¡æ•´ç›˜ï¼‰
        # ========================================

        # å¦‚æœç”¨æˆ·æ˜ç¡®æŒ‡å®šäº†è®¾å¤‡ï¼Œä½¿ç”¨ç”¨æˆ·æŒ‡å®šçš„
        - name: Use user-specified device if provided
          set_fact:
            selected_device: "{{ data_disk | regex_replace('^/dev/', '') }}"
            selection_method: "user-specified"
            user_specified: true
          when: data_disk is defined and data_disk != ''

        # å¦åˆ™ï¼Œä¼˜å…ˆé€‰æ‹©æœªæŒ‚è½½çš„åˆ†åŒº
        - name: Select largest unmounted partition (preferred)
          set_fact:
            selected_device: >-
              {{
                partition_candidates |
                selectattr('mountpoint', 'none') |
                sort(attribute='size', reverse=true) |
                first |
                default(none)
              }}
            selection_method: "auto-partition"
          when:
            - selected_device is not defined
            - partition_candidates | length > 0

        # å¦‚æœæ²¡æœ‰åˆé€‚çš„åˆ†åŒºï¼Œé€‰æ‹©æœªæŒ‚è½½çš„æ•´ç›˜
        - name: Select largest unmounted disk (fallback)
          set_fact:
            selected_device: >-
              {{
                disk_candidates |
                selectattr('mountpoint', 'none') |
                rejectattr('children', 'defined') |
                sort(attribute='size', reverse=true) |
                first |
                default(none)
              }}
            selection_method: "auto-disk"
          when:
            - selected_device is not defined or selected_device == none
            - disk_candidates | length > 0

        # å¦‚æœè¿˜æ˜¯æ²¡æœ‰ï¼Œé€‰æ‹©æŒ‚è½½åˆ°éæ ‡å‡†ä½ç½®çš„ç£ç›˜ï¼ˆå¯ä»¥é‡æ–°æŒ‚è½½ï¼‰
        - name: Select disk mounted to non-standard location (last resort)
          set_fact:
            selected_device: >-
              {{
                disk_candidates |
                rejectattr('mountpoint', 'none') |
                rejectattr('mountpoint', 'equalto', '/') |
                rejectattr('mountpoint', 'match', '^/boot') |
                rejectattr('children', 'defined') |
                sort(attribute='size', reverse=true) |
                first |
                default(none)
              }}
            selection_method: "auto-remount"
            needs_remount: true
          when:
            - selected_device is not defined or selected_device == none
            - disk_candidates | length > 0

        - name: Fail if no suitable device found
          fail:
            msg: |
              âŒ No suitable disk or partition found for /data

              Available disks:
              {{ disk_candidates | map(attribute='name') | list }}

              Available partitions:
              {{ partition_candidates | map(attribute='name') | list }}

              Please specify manually: -e "data_disk=/dev/sdX"
          when: selected_device is not defined or selected_device == none or selected_device == ''

        - name: Set device variables (for auto-selected device)
          set_fact:
            final_device: "/dev/{{ selected_device.name }}"
            device_size_gb: "{{ ((selected_device.size | int) / 1073741824) | round(1) }}"
            device_has_fs: "{{ (selected_device.fstype | default('')) != '' }}"
            device_fstype: "{{ selected_device.fstype | default('none') }}"
            old_mountpoint: "{{ selected_device.mountpoint | default('none') }}"
          when: user_specified is not defined or not user_specified

        - name: Set device variables (for user-specified device)
          set_fact:
            final_device: "/dev/{{ selected_device }}"
            device_size_gb: "unknown"
            device_has_fs: false
            device_fstype: "unknown"
          when: user_specified is defined and user_specified

        - name: Display selected device
          debug:
            msg:
              - "====== Selected Device ======"
              - "Device: {{ final_device }}"
              - "Size: {{ device_size_gb }}GB"
              - "Selection method: {{ selection_method }}"
              - "Has filesystem: {{ device_has_fs }} ({{ device_fstype }})"
              - "Old mountpoint: {{ old_mountpoint | default('none') }}"
              - "Needs remount: {{ needs_remount | default(false) }}"
              - "============================="

        # ========================================
        # 3.4 éªŒè¯è®¾å¤‡å­˜åœ¨
        # ========================================
        - name: Verify device exists
          stat:
            path: "{{ final_device }}"
          register: device_stat

        - name: Fail if device doesn't exist
          fail:
            msg: "âŒ Device {{ final_device }} does not exist!"
          when: not device_stat.stat.exists

        # ========================================
        # 3.5 Unmount if already mounted elsewhere
        # ========================================
        - name: Check if device is currently mounted
          shell: mount | grep "^{{ final_device }} " || true
          register: current_mount
          changed_when: false

        - name: Unmount device from old location if needed
          mount:
            path: "{{ current_mount.stdout.split()[2] }}"
            state: unmounted
          when:
            - current_mount.stdout != ''
            - needs_remount is defined and needs_remount
          register: unmount_result

        - name: Show unmount message
          debug:
            msg: "ğŸ”„ Unmounted {{ final_device }} from {{ current_mount.stdout.split()[2] }}"
          when:
            - unmount_result is changed

        # ========================================
        # 3.6 æ ¼å¼åŒ–ï¼ˆä»…åœ¨æ²¡æœ‰æ–‡ä»¶ç³»ç»Ÿæ—¶ï¼‰
        # ========================================
        - name: Check device filesystem type
          command: blkid -o value -s TYPE "{{ final_device }}"
          register: blkid_check
          failed_when: false
          changed_when: false

        - name: Format device if no filesystem
          filesystem:
            fstype: ext4
            dev: "{{ final_device }}"
            force: no
          when: blkid_check.rc != 0 or blkid_check.stdout == ''
          register: format_result

        - name: Show format result
          debug:
            msg: "âœ… Formatted {{ final_device }} as ext4"
          when: format_result is changed

        - name: Show skip format message
          debug:
            msg: "â­ï¸  Skipped formatting {{ final_device }} (already has {{ blkid_check.stdout }} filesystem)"
          when: format_result is skipped

        # ========================================
        # 3.7 åˆ›å»ºæŒ‚è½½ç‚¹
        # ========================================
        - name: Create mount point directory
          file:
            path: "{{ data_mount_point }}"
            state: directory
            owner: "{{ deploy_user | default('deploy') }}"
            group: "{{ deploy_user | default('deploy') }}"
            mode: '0755'

        # ========================================
        # 3.8 æŒ‚è½½å¹¶æ·»åŠ åˆ° fstabï¼ˆåŸå­æ“ä½œï¼‰
        # ========================================
        - name: Add to fstab and mount
          mount:
            path: "{{ data_mount_point }}"
            src: "{{ final_device }}"
            fstype: ext4
            opts: defaults,noatime
            state: mounted
          register: mount_result

        - name: Set ownership after mount
          file:
            path: "{{ data_mount_point }}"
            owner: "{{ deploy_user | default('deploy') }}"
            group: "{{ deploy_user | default('deploy') }}"
            mode: '0755'
            state: directory

        - name: Verify mount
          command: df -h "{{ data_mount_point }}"
          register: df_final
          changed_when: false

        - name: Display success
          debug:
            msg:
              - "âœ… Successfully mounted {{ final_device }} to {{ data_mount_point }}"
              - "{{ df_final.stdout }}"
              - ""
              - "This configuration is now persistent (added to /etc/fstab)"
