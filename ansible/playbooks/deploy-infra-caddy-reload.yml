---
- name: Reload Caddy Configuration (Fast)
  hosts: "{{ target_host | default('prod_servers') }}"  # é»˜è®¤ç”Ÿäº§ï¼Œä½†æ”¯æŒè¦†ç›–
  gather_facts: no

  vars:
    service_name: "caddy"
    local_config: "{{ playbook_dir }}/../../infra-apps/caddy/deploy-dist/config"
    remote_dir: "/srv/caddy"

  tasks:
    - debug:
        msg: "ğŸ”„ Reloading Caddy configuration..."

    # ===== Sync only config directory (from deploy-dist, built for specific server) =====
    - name: Sync config directory to server
      synchronize:
        src: "{{ local_config }}/"
        dest: "{{ remote_dir }}/config/"
        delete: no
        owner: no
        group: no
        rsync_opts:
          - "--exclude=preview/*"  # ä¿ç•™æœåŠ¡å™¨ä¸Šçš„ preview é…ç½®

    # ===== Reload Caddy =====
    - name: Reload Caddy configuration
      shell: |
        cd {{ remote_dir }}
        docker compose exec caddy caddy reload --config /etc/caddy/Caddyfile
      register: reload_result
      failed_when: false

    - name: Display reload output
      debug:
        msg: "{{ reload_result.stdout_lines }}"
      when: reload_result.stdout_lines is defined

    - name: Check reload status
      fail:
        msg: "âŒ Caddy reload failed! Error: {{ reload_result.stderr }}"
      when: reload_result.rc != 0

    - name: Display success message
      debug:
        msg: "âœ… Caddy configuration reloaded successfully"
      when: reload_result.rc == 0
