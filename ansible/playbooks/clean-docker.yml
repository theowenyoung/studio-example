---
# æ¸…ç† Dockerï¼ˆå®Œå…¨å¸è½½ + å¤‡ä»½æ•°æ®ï¼‰
# ä½¿ç”¨åœºæ™¯ï¼šç³»ç»Ÿé‡å»ºå‰å½»åº•æ¸…ç† Docker
- name: Clean Docker (Uninstall + Backup Data)
  hosts: all
  become: yes
  gather_facts: yes

  vars:
    docker_data_root: /data/docker

  tasks:
    # 1. å¤‡ä»½æ•°æ®ç›®å½•
    - name: Check if Docker data directory exists
      stat:
        path: "{{ docker_data_root }}"
      register: docker_data_dir

    - name: Create backup directory name with timestamp
      set_fact:
        backup_path: "{{ docker_data_root }}.old-{{ ansible_date_time.iso8601_basic_short }}"
      when: docker_data_dir.stat.exists

    - name: Move Docker data directory to backup
      command: mv "{{ docker_data_root }}" "{{ backup_path }}"
      when: docker_data_dir.stat.exists

    # 2. å®Œå…¨å¸è½½ Dockerï¼ˆå®˜æ–¹æ¨èæ–¹å¼ï¼‰
    - name: Purge Docker packages
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
          - docker-ce-rootless-extras
        state: absent
        purge: yes
      ignore_errors: yes

    # 3. æ¸…ç†æ®‹ç•™çš„ Docker ç½‘æ¡¥æ¥å£
    # apt purge ä¸ä¿è¯æ¸…ç†ç½‘æ¡¥ï¼Œéœ€è¦æ‰‹åŠ¨åˆ é™¤
    - name: Find Docker bridge interfaces
      shell: ip link show | grep -oP 'br-[a-f0-9]+' | sort -u
      register: docker_bridges
      changed_when: false
      failed_when: false

    - name: Remove Docker bridge interfaces
      shell: |
        ip link set {{ item }} down
        ip link delete {{ item }}
      loop: "{{ docker_bridges.stdout_lines }}"
      when: docker_bridges.stdout_lines | length > 0
      ignore_errors: yes

    # 4. æ¸…ç†æ®‹ç•™çš„ iptables è§„åˆ™
    - name: Flush Docker iptables chains
      shell: |
        iptables -t nat -F DOCKER 2>/dev/null || true
        iptables -t nat -X DOCKER 2>/dev/null || true
        iptables -F DOCKER 2>/dev/null || true
        iptables -F DOCKER-USER 2>/dev/null || true
        iptables -F DOCKER-ISOLATION-STAGE-1 2>/dev/null || true
        iptables -F DOCKER-ISOLATION-STAGE-2 2>/dev/null || true
        iptables -X DOCKER 2>/dev/null || true
        iptables -X DOCKER-USER 2>/dev/null || true
        iptables -X DOCKER-ISOLATION-STAGE-1 2>/dev/null || true
        iptables -X DOCKER-ISOLATION-STAGE-2 2>/dev/null || true
      changed_when: false
      ignore_errors: yes

    # 5. æ¸…ç†é»˜è®¤æ•°æ®ç›®å½•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    - name: Remove default Docker directories
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /var/lib/docker
        - /var/lib/containerd
      ignore_errors: yes

    # 6. æ¸…ç†é…ç½®æ–‡ä»¶
    - name: Remove Docker config
      file:
        path: /etc/docker/daemon.json
        state: absent
      ignore_errors: yes

    - name: Display completion message
      debug:
        msg:
          - "âœ… Docker å·²å®Œå…¨å¸è½½"
          - ""
          - "{% if docker_data_dir.stat.exists %}ğŸ“¦ æ•°æ®å·²å¤‡ä»½åˆ°: {{ backup_path }}{% else %}â„¹ï¸  æ— æ•°æ®éœ€è¦å¤‡ä»½{% endif %}"
          - "{% if docker_bridges.stdout_lines | length > 0 %}ğŸŒ‰ å·²æ¸…ç†ç½‘æ¡¥: {{ docker_bridges.stdout_lines | join(', ') }}{% endif %}"
          - ""
          - "ä¸‹ä¸€æ­¥ï¼š"
          - "  mise run server-update  # é‡æ–°å®‰è£…å’Œé…ç½® Docker"
          - ""
          - "ğŸ’¡ å¦‚éœ€æ¢å¤æ•°æ®ï¼š"
          - "  mv {{ backup_path | default(docker_data_root + '.old-*') }} {{ docker_data_root }}"
