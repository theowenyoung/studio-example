---
# æœåŠ¡å™¨åˆå§‹åŒ–ä¸»æµç¨‹
# ä½¿ç”¨æ–¹å¼: ansible-playbook -i inventory.yml playbooks/init-server.yml

# 1. åŸºç¡€ç³»ç»Ÿé…ç½®
- name: Bootstrap system
  hosts: all
  become: yes
  gather_facts: yes # åªåœ¨ç¬¬ä¸€ä¸ª play æ”¶é›† facts
  strategy: free # å…è®¸ä»»åŠ¡å¹¶è¡Œæ‰§è¡Œ

  roles:
    - role: robertdebock.bootstrap
      vars:
        bootstrap_become: yes
      tags: [bootstrap]

    # ç³»ç»Ÿæ›´æ–°é€šå¸¸å¾ˆæ…¢ï¼Œæ”¹ä¸ºå¯é€‰ï¼ˆä½¿ç”¨ --tags update æ˜¾å¼å¯ç”¨ï¼‰
    - role: robertdebock.update
      tags: [update, never] # æ·»åŠ  never æ ‡ç­¾ï¼Œé»˜è®¤è·³è¿‡
      when: force_system_update | default(false)

  post_tasks:
    # å®‰è£…å¸¸ç”¨å·¥å…·åŒ…ï¼ˆå¼‚æ­¥æ‰§è¡Œï¼Œä¸é˜»å¡åç»­ä»»åŠ¡ï¼‰
    - name: Install common packages
      apt:
        name: "{{ common_packages }}"
        state: present
        update_cache: yes
        cache_valid_time: 3600 # å¦‚æœ apt ç¼“å­˜åœ¨ 1 å°æ—¶å†…æœ‰æ•ˆï¼Œè·³è¿‡ updateï¼ˆèŠ‚çœæ—¶é—´ï¼‰
      when: common_packages is defined and common_packages | length > 0
      async: 300 # æœ€å¤šç­‰å¾… 5 åˆ†é’Ÿ
      poll: 0 # å¼‚æ­¥æ‰§è¡Œï¼Œä¸ç­‰å¾…å®Œæˆ
      register: install_packages
      tags: [packages, common]

    - name: Wait for package installation
      async_status:
        jid: "{{ install_packages.ansible_job_id }}"
      register: job_result
      until: job_result.finished
      retries: 60
      delay: 5
      when: common_packages is defined and common_packages | length > 0
      tags: [packages, common]

    # =====================================
    # è®¾ç½® /srv ç›®å½•æƒé™
    # =====================================
    - name: Set /srv directory ownership to deploy user
      file:
        path: /srv
        state: directory
        owner: "{{ deploy_user | default('deploy') }}"
        group: "{{ deploy_user | default('deploy') }}"
        mode: "0755"
      tags: [directories]

# 2. æŒ‚è½½æ•°æ®ç›˜
- import_playbook: mount.yml
  tags: [mount]

# 3. å®‰å…¨åŠ å›ºï¼ˆåœ¨ Docker ä¹‹å‰é…ç½® UFWï¼‰
- import_playbook: security.yml
  tags: [security]

# 4. å®‰è£… Dockerï¼ˆåœ¨ UFW ä¹‹åå®‰è£…ï¼ŒDocker ä¼šåœ¨å·²æœ‰é˜²ç«å¢™åŸºç¡€ä¸Šé…ç½®ï¼‰
- name: Install Docker
  hosts: all
  become: yes
  gather_facts: no # ä½¿ç”¨ç¼“å­˜çš„ facts

  roles:
    - role: geerlingguy.docker
      tags: [docker]

  post_tasks:
    - name: Add deploy user to docker group
      user:
        name: "{{ deploy_user | default('deploy') }}"
        groups: docker
        append: yes
      tags: [docker]

# 5. é…ç½® Dockerï¼ˆæ•°æ®ç›®å½•ã€ç½‘ç»œç­‰ï¼‰
- import_playbook: setup-docker.yml
  tags: [docker-setup]

# 6. é…ç½® AWS å‡­è¯ï¼ˆç”¨äº ECR é•œåƒæ‹‰å–ï¼‰
- import_playbook: configure-aws-credentials.yml
  tags: [aws-credentials]

# 7. å®‰è£…å’Œé…ç½® miseï¼ˆæœåŠ¡å™¨ä»»åŠ¡ç®¡ç†ï¼‰
- import_playbook: setup-mise.yml
  tags: [mise-setup]

# 8. åŒæ­¥æœåŠ¡å™¨é…ç½®æ–‡ä»¶ï¼ˆmise tasks å’Œ bash aliasesï¼‰
- import_playbook: sync-server-config.yml
  tags: [server-config]

# 9. éªŒè¯æ‰€æœ‰æœåŠ¡
- name: Verify all services
  hosts: all
  become: yes
  gather_facts: no

  tasks:
    - name: Verify services are running
      include_tasks: ../tasks/verify-services.yml
      tags: [verify, always]

# 7. æ˜¾ç¤ºå®Œæˆä¿¡æ¯
- name: Show completion message
  hosts: all
  gather_facts: no

  tasks:
    - name: Display success message
      debug:
        msg:
          - "ğŸ‰ æœåŠ¡å™¨åˆå§‹åŒ–å®Œæˆï¼"
          - ""
          - "å·²å®Œæˆçš„é…ç½®:"
          - "  âœ… ç³»ç»Ÿæ›´æ–°å’ŒåŸºç¡€é…ç½®"
          - "  âœ… å¸¸ç”¨å·¥å…·åŒ…å®‰è£…"
          - "  âœ… æ•°æ®ç›˜æŒ‚è½½ (/data)"
          - "  âœ… å®‰å…¨åŠ å›º (SSH, é˜²ç«å¢™, Fail2ban)"
          - "  âœ… Docker å®‰è£…å’Œé…ç½®"
          - "  âœ… å…±äº«ç½‘ç»œåˆ›å»º"
          - "  âœ… docker-rollout å·¥å…·"
          - "  âœ… AWS å‡­è¯é…ç½® (ECR è®¿é—®)"
          - "  âœ… mise ä»»åŠ¡ç®¡ç†å·¥å…·"
          - "  âœ… Shell åˆ«åå’Œå¿«æ·å‘½ä»¤"
          - ""
          - "æœåŠ¡å™¨ä¸Šå¯ç”¨çš„å·¥å…·:"
          - "  mise tasks          # åˆ—å‡ºæ‰€æœ‰è¿ç»´ä»»åŠ¡"
          - "  mise run <task>     # æ‰§è¡Œä»»åŠ¡"
          - "  m <task>            # ä½¿ç”¨åˆ«å"
          - "  ll, dc      # Shell åˆ«å"
          - ""
          - "æ³¨æ„ï¼š"
          - "  - æ‰€æœ‰æœåŠ¡ç›®å½•ä¼šåœ¨é¦–æ¬¡éƒ¨ç½²æ—¶è‡ªåŠ¨åˆ›å»º"
          - "  - Docker åœ¨ UFW ä¹‹åå®‰è£…ï¼Œå¯æ­£ç¡®å¤„ç† iptables"
          - ""
          - "ä¸‹ä¸€æ­¥ï¼š"
          - "  mise run deploy-infra"
      tags: [always]
