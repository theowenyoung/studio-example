name: Run db-prepare

on:
  workflow_dispatch:
    inputs:
      server:
        description: "Target server"
        required: true
        type: choice
        default: "auto"
        options:
          - "all" # æ‰€æœ‰ prod æœåŠ¡å™¨ï¼ˆprod1 + prod2ï¼‰
          - "auto" # æ ¹æ®åˆ†æ”¯è‡ªåŠ¨æ£€æµ‹ï¼šmain=prod1, other=preview
          - "prod1"
          - "prod2"

env:
  ECR_REGISTRY: YOUR_AWS_ACCOUNT_ID.dkr.ecr.us-west-2.amazonaws.com

jobs:
  run-db-prepare:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Determine environment
        id: env
        run: |
          if [ "${{ github.ref_name }}" = "main" ]; then
            echo "deploy_env=prod" >> $GITHUB_OUTPUT
            echo "param_path=/studio-prod/" >> $GITHUB_OUTPUT
          else
            echo "deploy_env=preview" >> $GITHUB_OUTPUT
            echo "param_path=/studio-dev/" >> $GITHUB_OUTPUT
          fi

      - name: Cache mise
        uses: actions/cache@v4
        with:
          path: ~/.local/share/mise
          key: mise-${{ runner.os }}-${{ hashFiles('.mise/config.toml') }}

      - name: Install mise
        run: |
          curl https://mise.run | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Setup mise
        run: |
          mise install

      - name: Cache Ansible Galaxy dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.ansible/roles
            ~/.ansible/collections
          key: ansible-galaxy-${{ hashFiles('ansible/requirements.yml') }}

      - name: Install Ansible Galaxy dependencies
        run: |
          ansible-galaxy install -r ansible/requirements.yml

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.CI_AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.CI_AWS_SECRET_ACCESS_KEY }}
          aws-region: us-west-2

      - name: Load SSH key from Parameter Store
        run: |
          DEPLOY_SSH_KEY=$(aws ssm get-parameter --name "${{ steps.env.outputs.param_path }}DEPLOY_SSH_KEY" --with-decryption --query "Parameter.Value" --output text)

          mkdir -p ~/.ssh
          echo "${DEPLOY_SSH_KEY}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          echo "âœ… SSH key loaded (env: ${{ steps.env.outputs.deploy_env }})"

      - name: Login to ECR
        run: |
          aws ecr get-login-password --region us-west-2 | \
            docker login --username AWS --password-stdin ${{ env.ECR_REGISTRY }}

      - name: Run db-prepare
        run: |
          SERVER="${{ inputs.server }}"
          if [ "$SERVER" = "auto" ]; then
            mise run deploy-db-prepare
          elif [ "$SERVER" = "all" ]; then
            echo "ðŸš€ Running db-prepare on all active prod servers..."
            # Get active prod servers from inventory (not commented out)
            SERVERS=$(grep -A 100 "prod_servers:" ansible/inventory.yml | grep -E "^\s+prod[0-9]+:" | sed 's/://g' | awk '{print $1}')
            for srv in $SERVERS; do
              echo "ðŸ“¦ Running db-prepare on $srv..."
              mise run deploy-db-prepare "$srv"
            done
          else
            mise run deploy-db-prepare "$SERVER"
          fi
        env:
          ANSIBLE_SSH_PRIVATE_KEY_FILE: ~/.ssh/id_rsa

      - name: Summary
        if: always()
        run: |
          echo "### db-prepare Result" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Branch: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Environment: \`${{ steps.env.outputs.deploy_env }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Server: \`${{ inputs.server }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- Triggered by: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
