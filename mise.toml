# Tools are defined in .mise/config.toml (separate file for CI cache optimization)

[env]
# AWS ECR registry
ECR_REGISTRY = "YOUR_AWS_ACCOUNT_ID.dkr.ecr.us-west-2.amazonaws.com"

# ==================== å¼€å‘ç›¸å…³ (dev-) ====================
# å¼€å‘æœåŠ¡å™¨ + æœ¬åœ° Docker + ç¯å¢ƒå˜é‡

[tasks.dev-hono]
description = "Start hono-demo development server"
run = 'pnpm --filter "hono-demo" dev'

[tasks.dev-hono-prod2]
description = "Start hono-prod2-demo development server"
run = 'pnpm --filter "hono-prod2-demo" dev'

[tasks.dev-proxy]
description = "Start proxy development server"
run = 'pnpm --filter "proxy" dev'

[tasks.dev-api]
description = "Start api development server"
run = 'pnpm --filter "api" dev'

[tasks.dev-meilisearch]
description = "Start meilisearch service"
run = 'docker compose up'
dir = "external-apps/meilisearch"

[tasks.dev-umami]
description = "Start umami (umami analytics) service"
run = 'docker compose up'
dir = "external-apps/umami"

[tasks.dev-status]
description = "Start status (gatus status page) service"
run = 'docker compose up'
dir = "external-apps/status"

[tasks.dev-n8n]
description = "Start n8n (workflow automation) service"
run = 'docker compose up'
dir = "external-apps/n8n"

[tasks.dev-outline]
description = "Start outline (wiki) service"
run = 'docker compose up'
dir = "external-apps/outline"

[tasks.dev-build-vault-clip]
description = "Build vault-clip locally for development (no ECR push)"
run = 'bash external-apps/vault-clip/build.sh'
env = { LOCAL_DEV = "true" }

[tasks.dev-vault-clip]
description = "Start vault-clip service (requires dev-build-vault-clip first)"
run = 'docker compose up'
dir = "external-apps/vault-clip"

[tasks.dev-build-vault-highlights]
description = "Build vault-highlights locally for development (no ECR push)"
run = 'bash external-apps/vault-highlights/build.sh'
env = { LOCAL_DEV = "true" }

[tasks.dev-vault-highlights]
description = "Start vault-highlights service (requires dev-build-vault-highlights first)"
run = 'docker compose up'
dir = "external-apps/vault-highlights"

[tasks.dev-build-vault-bookmarks]
description = "Build vault-bookmarks locally for development (no ECR push)"
run = 'bash external-apps/vault-bookmarks/build.sh'
env = { LOCAL_DEV = "true" }

[tasks.dev-vault-bookmarks]
description = "Start vault-bookmarks service (requires dev-build-vault-bookmarks first)"
run = 'docker compose up'
dir = "external-apps/vault-bookmarks"

[tasks.dev-build-vault-snapshots]
description = "Build vault-snapshots locally for development (no ECR push)"
run = 'bash external-apps/vault-snapshots/build.sh'
env = { LOCAL_DEV = "true" }

[tasks.dev-vault-snapshots]
description = "Start vault-snapshots service (requires dev-build-vault-snapshots first)"
run = 'docker compose up'
dir = "external-apps/vault-snapshots"

[tasks.dev-build-microbin]
description = "Build microbin locally for development (no ECR push)"
run = 'bash external-apps/microbin/build.sh'
env = { LOCAL_DEV = "true" }

[tasks.dev-microbin]
description = "Start microbin service (requires dev-build-microbin first)"
run = 'docker compose up'
dir = "external-apps/microbin"

[tasks.dev-redlib]
description = "Start redlib (Reddit frontend) service"
run = 'docker compose up'
dir = "external-apps/redlib"

[tasks.dev-all]
description = "Start all development servers"
alias = "dev"
run = 'pnpm --parallel --filter "./js-apps/*" dev'

[tasks.dev-kill]
description = "Kill all development servers (cleanup after Ctrl+C)"
run = '''
echo "ğŸ”ª Killing all development servers..."
# æ€æ­»å¸¸è§çš„å¼€å‘æœåŠ¡å™¨è¿›ç¨‹
pkill -f "vite" || true
pkill -f "remix dev" || true
pkill -f "next dev" || true
pkill -f "node.*dev" || true
pkill -f "tsx watch" || true
# æ€æ­»å ç”¨å¸¸è§å¼€å‘ç«¯å£çš„è¿›ç¨‹
lsof -ti:3000,3001,5173,8001,8002,8003,9001,9002,9003 | xargs kill -9 2>/dev/null || true
echo "âœ… All development servers killed"
'''

[tasks.dev-init]
description = "Initialize local environment (create Docker network)"
alias = "init"
run = 'docker network create shared'

[tasks.dev-up]
description = "Start all local infrastructure"
alias = "up"
depends = ["dev-up-postgres", "dev-up-redis", "dev-up-caddy", "dev-up-meilisearch"]

[tasks.dev-down]
description = "Stop all local infrastructure"
alias = "down"
depends = ["dev-down-postgres", "dev-down-redis", "dev-down-caddy", "dev-down-meilisearch"]

[tasks.clean-docker]
description = "Clean Docker containers and volumes (specific app or all)"
alias = "dev-clean-docker"
usage = 'arg "[app]" help="Optional: app name (e.g., status) to clean only that app"'
run = '''
#!/bin/bash
set -e

TARGET="${usage_app:-}"

if [ -n "$TARGET" ]; then
  # Clean specific app
  FOUND=0
  for app_dir in *-apps/"$TARGET"; do
    if [ -f "$app_dir/docker-compose.yml" ]; then
      echo "ğŸ§¹ Cleaning $TARGET (down -v)..."
      docker compose --project-directory "$app_dir" down -v
      echo "âœ… $TARGET cleaned"
      FOUND=1
      break
    fi
  done

  if [ "$FOUND" -eq 0 ]; then
    echo "âŒ App not found: $TARGET"
    exit 1
  fi
else
  # Clean all
  echo "âš ï¸  WARNING: This will DELETE all local Docker data!"
  echo ""
  echo "This will:"
  echo "  â€¢ Stop all infrastructure containers (postgres, redis, caddy, meilisearch)"
  echo "  â€¢ Remove all containers"
  echo "  â€¢ Remove all volumes (databases, cache, logs)"
  echo ""
  echo "ğŸ’¡ You will need to run 'mise run init' and 'mise run dev-db-prepare' after this"
  echo ""
  read -p "Are you sure? Type 'yes' to continue: " confirm

  if [ "$confirm" != "yes" ]; then
      echo "Aborted."
      exit 0
  fi

  echo ""
  echo "ğŸ§¹ Cleaning local Docker environment..."
  echo ""

  # Stop all services
  echo "1. Stopping all services..."
  mise run down 2>/dev/null || true

  # Remove containers with volumes
  echo "2. Removing containers and volumes..."
  for app_dir in *-apps/*/; do
    if [ -f "${app_dir}docker-compose.yml" ]; then
      echo "  Cleaning $(basename $app_dir)..."
      docker compose --project-directory "$app_dir" down -v 2>/dev/null || true
    fi
  done

  # Prune any dangling volumes
  echo "3. Pruning dangling volumes..."
  docker volume prune -f 2>/dev/null || true

  echo ""
  echo "âœ… Local Docker environment cleaned!"
  echo ""
  echo "ğŸ“‹ Next steps:"
  echo "   mise run up          # Start infrastructure"
  echo "   mise run dev-db-prepare     # Initialize database"
  echo "   mise run env         # Fetch environment variables"
  echo ""
fi
'''

[tasks.dev-logs]
description = "View logs from all local infrastructure services"
alias = "logs"
run = '''
echo "Starting log tail for postgres, redis, and caddy..."
echo "Press Ctrl+C to stop"
echo ""
docker compose -f infra-apps/postgres/docker-compose.yml -f infra-apps/redis/docker-compose.yml -f infra-apps/caddy/docker-compose.yml logs -f --tail=50
'''

[tasks.dev-logs-postgres]
description = "View PostgreSQL logs"
run = 'docker compose logs -f --tail=100'
dir = "infra-apps/postgres"

[tasks.dev-logs-redis]
description = "View Redis logs"
run = 'docker compose logs -f --tail=100'
dir = "infra-apps/redis"

[tasks.dev-logs-caddy]
description = "View Caddy logs"
run = 'docker compose logs -f --tail=100'
dir = "infra-apps/caddy"

[tasks.dev-up-postgres]
description = "Start local PostgreSQL"
run = 'docker compose up -d --remove-orphans --force-recreate'
dir = "infra-apps/postgres"

[tasks.dev-up-redis]
description = "Start local Redis"
run = 'docker compose up -d --remove-orphans --force-recreate'
dir = "infra-apps/redis"

[tasks.dev-up-caddy]
description = "Start local Caddy"
run = 'docker compose up -d --remove-orphans --force-recreate'
dir = "infra-apps/caddy"

[tasks.dev-down-postgres]
description = "Stop local PostgreSQL"
run = 'docker compose down'
dir = "infra-apps/postgres"

[tasks.dev-down-redis]
description = "Stop local Redis"
run = 'docker compose down'
dir = "infra-apps/redis"

[tasks.dev-down-caddy]
description = "Stop local Caddy"
run = 'docker compose down'
dir = "infra-apps/caddy"

[tasks.dev-reload-caddy]
description = "Reload local Caddy config"
run = 'docker compose exec caddy caddy reload --config /etc/caddy/Caddyfile'
dir = "infra-apps/caddy"

[tasks.dev-up-meilisearch]
description = "Start local Meilisearch"
run = 'docker compose up -d --remove-orphans --force-recreate'
dir = "external-apps/meilisearch"

[tasks.dev-down-meilisearch]
description = "Stop local Meilisearch"
run = 'docker compose down'
dir = "external-apps/meilisearch"

[tasks.dev-logs-meilisearch]
description = "View Meilisearch logs"
run = 'docker compose logs -f --tail=100'
dir = "external-apps/meilisearch"

[tasks.env]
description = "Fetch development environment variables (all or specific app)"
alias = "dev-env"
usage = 'arg "[app]" help="Optional: app name (e.g., status, hono-demo) or path (e.g., external-apps/status)"'
run = """
echo "ğŸ” Fetching dev environment variables..."
echo ""

TARGET="${usage_app:-}"

# Scan all app directories for .env.example
for app_dir in js-apps/* infra-apps/* external-apps/*; do
  if [ -f "$app_dir/.env.example" ]; then
    app_name=$(basename "$app_dir")
    parent_dir=$(dirname "$app_dir")

    # If target specified, filter by app name or full path
    if [ -n "$TARGET" ]; then
      if [ "$app_name" != "$TARGET" ] && [ "$app_dir" != "$TARGET" ]; then
        continue
      fi
    fi

    echo "ğŸ“¦ $parent_dir/$app_name"
    psenv -t "$app_dir/.env.example" -p "/studio-dev/" -o "$app_dir/.env"
  fi
done

echo ""
echo "âœ… Environment variables fetched!"
"""

[tasks.env-push]
description = "Upload environment variables to AWS Parameter Store from .env.parameter.local"
run = "bash scripts/env-push.sh .env.parameter.local"

[tasks.dev-backup]
description = "Run backup in dev environment"
run = 'docker compose run --rm backup /usr/local/bin/backup-all.sh'
dir = "infra-apps/backup"

# ==================== æ•°æ®åº“æ“ä½œ (dev-db-) ====================

[tasks.db]
description = "Connect to PostgreSQL database"
alias = "dev-db-connect"
run = 'docker compose exec postgres psql -U postgres'
dir = "infra-apps/postgres"

[tasks.dev-db-prepare]
description = "Initialize database (run admin migrations)"
run = """
# Build with all migrations to dist/ (local mode)
# LOCAL_DEV=true forces /studio-dev/ params regardless of branch
LOCAL_DEV=true TARGET_SERVER=local BUILD_OUTPUT_DIR=dist bash build.sh
# Run from dist
docker compose -f dist/docker-compose.yml run --rm db-prepare
"""
dir = "infra-apps/db-prepare"

[tasks.dev-db-migrate]
description = "Run all application migrations"
run = 'pnpm --filter "./js-apps/*" migrate'

[tasks.dev-db-migrate-hono]
description = "Run hono-demo migrations"
run = 'pnpm --filter "./js-apps/hono-demo" migrate'

# ==================== æ„å»º (build-) ====================

# åŸºç¡€è®¾æ–½æ„å»º
[tasks.build-postgres]
description = "Build PostgreSQL infrastructure"
run = "bash infra-apps/postgres/build.sh"

[tasks.build-redis]
description = "Build Redis infrastructure"
run = "bash infra-apps/redis/build.sh"

[tasks.build-caddy]
description = "Build Caddy infrastructure"
run = "bash infra-apps/caddy/build.sh"

[tasks.build-backup]
description = "Build backup infrastructure"
run = "bash infra-apps/backup/build.sh"

# JS åº”ç”¨æ„å»º
[tasks.build-hono-demo]
description = "Build hono-demo application"
run = "bash js-apps/hono-demo/build.sh"

[tasks.build-hono-prod2-demo]
description = "Build hono-prod2-demo application (deploys to prod2)"
run = "bash js-apps/hono-prod2-demo/build.sh"

[tasks.build-proxy]
description = "Build proxy application"
run = "bash js-apps/proxy/build.sh"

[tasks.build-blog]
description = "Build blog application"
run = "bash js-apps/blog/build.sh"

[tasks.build-storefront]
description = "Build storefront application"
run = "bash js-apps/storefront/build.sh"

[tasks.build-api]
description = "Build api application"
run = "bash js-apps/api/build.sh"

[tasks.build-admin]
description = "Build admin application"
run = "bash js-apps/admin/build.sh"

# External åº”ç”¨æ„å»º
[tasks.build-meilisearch]
description = "Build meilisearch"
run = "bash external-apps/meilisearch/build.sh"

[tasks.build-owen-blog]
description = "Build owen-blog"
run = "bash external-apps/owen-blog/build.sh"

[tasks.build-buzzing-archive]
description = "Build buzzing-archive"
run = "bash external-apps/buzzing-archive/build.sh"

[tasks.build-umami]
description = "Build umami (Umami Analytics)"
run = "bash external-apps/umami/build.sh"

[tasks.build-status]
description = "Build status (Gatus Status Page)"
run = "bash external-apps/status/build.sh"

[tasks.build-n8n]
description = "Build n8n (Workflow Automation)"
run = "bash external-apps/n8n/build.sh"

[tasks.build-outline]
description = "Build outline (Wiki)"
run = "bash external-apps/outline/build.sh"

[tasks.build-vault-clip]
description = "Build vault-clip"
run = "bash external-apps/vault-clip/build.sh"

[tasks.build-vault-highlights]
description = "Build vault-highlights"
run = "bash external-apps/vault-highlights/build.sh"

[tasks.build-vault-bookmarks]
description = "Build vault-bookmarks"
run = "bash external-apps/vault-bookmarks/build.sh"

[tasks.build-vault-snapshots]
description = "Build vault-snapshots"
run = "bash external-apps/vault-snapshots/build.sh"

[tasks.build-microbin]
description = "Build microbin (Pastebin)"
run = "bash external-apps/microbin/build.sh"

[tasks.build-redlib]
description = "Build redlib (Reddit Frontend)"
run = "bash external-apps/redlib/build.sh"

# ==================== éƒ¨ç½² (deploy-) ====================

# åŸºç¡€è®¾æ–½éƒ¨ç½²
[tasks.deploy-infra]
description = "Deploy all infrastructure services (auto-detect environment from git branch)"
run = [
  "bash scripts/deploy-infra.sh all",
  "mise run deploy-db-prepare"
]

[tasks.deploy-postgres]
description = "Deploy PostgreSQL (auto-detect environment)"
run = "bash scripts/deploy-infra.sh postgres"

[tasks.deploy-redis]
description = "Deploy Redis (auto-detect environment)"
run = "bash scripts/deploy-infra.sh redis"

[tasks.deploy-caddy]
description = "Deploy Caddy (auto-detect environment, specify server for prod)"
usage = 'arg "[server]" help="Target server for prod: all (default), prod1, prod2" default=""'
run = """
if [ -n "${usage_server}" ]; then
  bash scripts/deploy-infra.sh caddy --server="${usage_server}"
else
  bash scripts/deploy-infra.sh caddy
fi
"""

[tasks.reload-caddy]
description = "Reload Caddy config on target server (no Docker build)"
usage = 'arg "[server]" help="Target server: prod1, prod2, preview, or all" default=""'
run = """
#!/bin/bash
set -e
source scripts/build-lib.sh
detect_environment

TARGET="${usage_server}"

if [ "$DEPLOY_ENV" = "prod" ]; then
  if [ -z "$TARGET" ] || [ "$TARGET" = "all" ]; then
    # Get active prod servers from inventory
    SERVERS=$(grep -A 100 "prod_servers:" ansible/inventory.yml | grep -E "^\\s+prod[0-9]+:" | sed 's/://g' | awk '{print $1}')
    for srv in $SERVERS; do
      echo "ğŸ”„ Reloading Caddy config for $srv..."
      bash infra-apps/caddy/build.sh --config-only "$srv"
      ansible-playbook -i ansible/inventory.yml ansible/playbooks/deploy-infra-caddy-reload.yml -l "$srv"
    done
  else
    echo "ğŸ”„ Reloading Caddy config for $TARGET..."
    bash infra-apps/caddy/build.sh --config-only "$TARGET"
    ansible-playbook -i ansible/inventory.yml ansible/playbooks/deploy-infra-caddy-reload.yml -l "$TARGET"
  fi
else
  # Preview: no server-specific build needed
  echo "ğŸ”„ Reloading Caddy config for preview..."
  bash infra-apps/caddy/build.sh --config-only
  ansible-playbook -i ansible/inventory.yml ansible/playbooks/deploy-infra-caddy-reload.yml -l preview
fi
"""

[tasks.deploy-backup]
description = "Deploy backup service (production only)"
run = "bash scripts/deploy-infra.sh backup"

# JS åº”ç”¨éƒ¨ç½²ï¼ˆæ™ºèƒ½æ£€æµ‹ç¯å¢ƒï¼šmain=production, å…¶ä»–=previewï¼‰
[tasks.deploy-apps]
description = "Deploy all applications (auto-scan js-apps and external-apps)"
alias = "deploy-all"
run = """
#!/bin/bash
set -e

echo "ğŸš€ Building and deploying all applications..."
echo ""

# Helper: check if target server is configured in inventory
check_server_configured() {
  local server="$1"
  # Check if server is uncommented in inventory.yml
  if grep -E "^\\s+${server}:" ansible/inventory.yml > /dev/null 2>&1; then
    return 0
  fi
  return 1
}

# Helper: get DEPLOY_SERVER from .env.example
get_deploy_server() {
  local env_file="$1"
  if [ -f "$env_file" ]; then
    grep -E "^DEPLOY_SERVER=" "$env_file" 2>/dev/null | cut -d'=' -f2 | tr -d '"' || true
  fi
}

# Deploy js-apps (apps with build.sh)
echo "ğŸ“¦ Scanning js-apps..."
for app_dir in js-apps/*/; do
  if [ -f "${app_dir}build.sh" ]; then
    app_name=$(basename "$app_dir")

    # Check if app targets a specific server that's not configured
    deploy_server=$(get_deploy_server "${app_dir}.env.example")
    if [ -n "$deploy_server" ] && ! check_server_configured "$deploy_server"; then
      echo "â­ï¸  Skipping $app_name (target server '$deploy_server' not configured)"
      continue
    fi

    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ“¦ js-app: $app_name"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ”¨ Building..."
    bash "${app_dir}build.sh"
    echo "ğŸš€ Deploying..."
    bash scripts/deploy-app.sh "$app_name"
  fi
done

echo ""

# Deploy external-apps (apps with build.sh)
echo "ğŸ“¦ Scanning external-apps..."
for app_dir in external-apps/*/; do
  if [ -f "${app_dir}build.sh" ]; then
    app_name=$(basename "$app_dir")

    # Check if app targets a specific server that's not configured
    deploy_server=$(get_deploy_server "${app_dir}.env.example")
    if [ -n "$deploy_server" ] && ! check_server_configured "$deploy_server"; then
      echo "â­ï¸  Skipping $app_name (target server '$deploy_server' not configured)"
      continue
    fi

    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ“¦ external-app: $app_name"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ”¨ Building..."
    bash "${app_dir}build.sh"
    echo "ğŸš€ Deploying..."
    bash scripts/deploy-external-app.sh "$app_name"
  fi
done

echo ""
echo "âœ… All applications built and deployed!"
"""

[tasks.deploy-js-apps]
description = "Deploy all JS applications (auto-scan js-apps)"
run = """
#!/bin/bash
set -e

echo "ğŸš€ Building and deploying all JS applications..."
echo ""

# Helper: check if target server is configured in inventory
check_server_configured() {
  local server="$1"
  if grep -E "^\\s+${server}:" ansible/inventory.yml > /dev/null 2>&1; then
    return 0
  fi
  return 1
}

# Helper: get DEPLOY_SERVER from .env.example
get_deploy_server() {
  local env_file="$1"
  if [ -f "$env_file" ]; then
    grep -E "^DEPLOY_SERVER=" "$env_file" 2>/dev/null | cut -d'=' -f2 | tr -d '"' || true
  fi
}

for app_dir in js-apps/*/; do
  if [ -f "${app_dir}build.sh" ]; then
    app_name=$(basename "$app_dir")

    deploy_server=$(get_deploy_server "${app_dir}.env.example")
    if [ -n "$deploy_server" ] && ! check_server_configured "$deploy_server"; then
      echo "â­ï¸  Skipping $app_name (target server '$deploy_server' not configured)"
      continue
    fi

    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ“¦ js-app: $app_name"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ”¨ Building..."
    bash "${app_dir}build.sh"
    echo "ğŸš€ Deploying..."
    bash scripts/deploy-app.sh "$app_name"
  fi
done

echo ""
echo "âœ… All JS applications built and deployed!"
"""

[tasks.deploy-external-apps]
description = "Deploy all external applications (auto-scan external-apps)"
run = """
#!/bin/bash
set -e

echo "ğŸš€ Building and deploying all external applications..."
echo ""

# Helper: check if target server is configured in inventory
check_server_configured() {
  local server="$1"
  if grep -E "^\\s+${server}:" ansible/inventory.yml > /dev/null 2>&1; then
    return 0
  fi
  return 1
}

# Helper: get DEPLOY_SERVER from .env.example
get_deploy_server() {
  local env_file="$1"
  if [ -f "$env_file" ]; then
    grep -E "^DEPLOY_SERVER=" "$env_file" 2>/dev/null | cut -d'=' -f2 | tr -d '"' || true
  fi
}

for app_dir in external-apps/*/; do
  if [ -f "${app_dir}build.sh" ]; then
    app_name=$(basename "$app_dir")

    deploy_server=$(get_deploy_server "${app_dir}.env.example")
    if [ -n "$deploy_server" ] && ! check_server_configured "$deploy_server"; then
      echo "â­ï¸  Skipping $app_name (target server '$deploy_server' not configured)"
      continue
    fi

    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ“¦ external-app: $app_name"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ”¨ Building..."
    bash "${app_dir}build.sh"
    echo "ğŸš€ Deploying..."
    bash scripts/deploy-external-app.sh "$app_name"
  fi
done

echo ""
echo "âœ… All external applications built and deployed!"
"""

[tasks.deploy-hono-demo]
description = "Deploy hono-demo (auto-detect environment)"
depends = ["build-hono-demo"]
run = "bash scripts/deploy-app.sh hono-demo"
alias = "deploy-hono"

[tasks.deploy-hono-prod2-demo]
description = "Deploy hono-prod2-demo to prod2 (auto-detect environment)"
depends = ["build-hono-prod2-demo"]
run = "bash scripts/deploy-app.sh hono-prod2-demo"

[tasks.deploy-proxy]
description = "Deploy proxy (auto-detect environment)"
depends = ["build-proxy"]
run = "bash scripts/deploy-app.sh proxy"

[tasks.deploy-blog]
description = "Deploy blog (auto-detect environment)"
depends = ["build-blog"]
run = "bash scripts/deploy-app.sh blog"

[tasks.deploy-storefront]
description = "Deploy storefront (auto-detect environment)"
depends = ["build-storefront"]
run = "bash scripts/deploy-app.sh storefront"

[tasks.deploy-api]
description = "Deploy api (auto-detect environment)"
depends = ["build-api"]
run = "bash scripts/deploy-app.sh api"

[tasks.deploy-admin]
description = "Deploy admin (auto-detect environment)"
depends = ["build-admin"]
run = "bash scripts/deploy-app.sh admin"

# External åº”ç”¨éƒ¨ç½²
[tasks.deploy-meilisearch]
description = "Deploy meilisearch (auto-detect environment)"
run = "bash scripts/deploy-external-app.sh meilisearch"

[tasks.deploy-owen-blog]
description = "Deploy owen-blog (auto-detect environment)"
run = "bash scripts/deploy-external-app.sh owen-blog"

[tasks.post-deploy-owen-blog]
description = "Build search index for owen-blog (run after deploy)"
run = "bash external-apps/owen-blog/post-deploy.sh"

[tasks.deploy-buzzing-archive]
description = "Deploy buzzing-archive (auto-detect environment)"
run = "bash scripts/deploy-external-app.sh buzzing-archive"

[tasks.deploy-umami]
description = "Deploy umami (auto-detect environment)"
run = "bash scripts/deploy-external-app.sh umami"

[tasks.deploy-status]
description = "Deploy status (auto-detect environment)"
run = "bash scripts/deploy-external-app.sh status"

[tasks.deploy-n8n]
description = "Deploy n8n (auto-detect environment)"
run = "bash scripts/deploy-external-app.sh n8n"

[tasks.deploy-outline]
description = "Deploy outline (auto-detect environment)"
run = "bash scripts/deploy-external-app.sh outline"

[tasks.deploy-vault-clip]
description = "Deploy vault-clip (auto-detect environment)"
run = "bash scripts/deploy-external-app.sh vault-clip"

[tasks.deploy-vault-highlights]
description = "Deploy vault-highlights (auto-detect environment)"
run = "bash scripts/deploy-external-app.sh vault-highlights"

[tasks.deploy-vault-bookmarks]
description = "Deploy vault-bookmarks (auto-detect environment)"
run = "bash scripts/deploy-external-app.sh vault-bookmarks"

[tasks.deploy-vault-snapshots]
description = "Deploy vault-snapshots (auto-detect environment)"
run = "bash scripts/deploy-external-app.sh vault-snapshots"

[tasks.deploy-microbin]
description = "Deploy microbin (auto-detect environment)"
run = "bash scripts/deploy-external-app.sh microbin"

[tasks.deploy-redlib]
description = "Deploy redlib (auto-detect environment)"
run = "bash scripts/deploy-external-app.sh redlib"

# æ•°æ®åº“è¿ç§»éƒ¨ç½²
# ç”¨æ³•:
#   mr deploy-db-prepare         # prod: æ‰€æœ‰æ¿€æ´»çš„æœåŠ¡å™¨, preview: preview æœåŠ¡å™¨
#   mr deploy-db-prepare prod2   # æŒ‡å®šå•ä¸ªæœåŠ¡å™¨
[tasks.deploy-db-prepare]
description = "Run database migrations on all active prod servers or specific one"
usage = 'arg "[server]" help="Target server: all (default for prod), prod1, prod2, etc." default=""'
run = """
#!/bin/bash
set -e
source scripts/build-lib.sh
detect_environment

TARGET="${usage_server}"

if [ "$DEPLOY_ENV" = "prod" ]; then
  if [ -z "$TARGET" ] || [ "$TARGET" = "all" ]; then
    # Get active prod servers from inventory
    SERVERS=$(grep -A 100 "prod_servers:" ansible/inventory.yml | grep -E "^\\s+prod[0-9]+:" | sed 's/://g' | awk '{print $1}')
    for srv in $SERVERS; do
      echo "ğŸ“¦ Running db-prepare on $srv..."
      bash scripts/deploy-db-prepare.sh --server="$srv"
    done
  else
    bash scripts/deploy-db-prepare.sh --server="$TARGET"
  fi
else
  # Preview: single server
  bash scripts/deploy-db-prepare.sh
fi
"""



# ==================== æœåŠ¡å™¨ç®¡ç† (server-) ====================
#
# ä»»åŠ¡åˆ†ç±»åŸåˆ™ï¼š
#
# ã€ç¬¬ä¸€ç±»ã€‘ä¸¥æ ¼åˆ†æ”¯ç»‘å®š (Strict Branch Binding)
# - è§„åˆ™ï¼šåœ¨ main åˆ†æ”¯åªèƒ½æ“ä½œ Prodï¼Œåœ¨å…¶ä»–åˆ†æ”¯åªèƒ½æ“ä½œ Preview
# - åŒ…æ‹¬ï¼šdeploy-*, server-update, sync-config, server-configure-aws, backup, clean-docker
# - åŸå› ï¼šè¿™äº›æ“ä½œä¼šä¿®æ”¹é…ç½®æ–‡ä»¶æˆ–åŒæ­¥ä»£ç ï¼Œå¿…é¡»ç¡®ä¿ç¯å¢ƒéš”ç¦»
#
# ã€ç¬¬äºŒç±»ã€‘æ˜¾å¼æŒ‡å®šç›®æ ‡ (Explicit Targeting)
# - è§„åˆ™ï¼šå¿…é¡»åœ¨ä»»åŠ¡åä¸­æ˜ç¡®æŒ‡å®š -prod/-preview åç¼€
# - åŒ…æ‹¬ï¼šserver-init-*, server-resize-volume-*, ssh-*
# - åŸå› ï¼šåˆå§‹åŒ–/å±é™©æ“ä½œå¤ªé‡è¦ï¼Œresize é¢‘ç‡æä½ï¼Œå¿…é¡»æ‰‹åŠ¨ç¡®è®¤ç›®æ ‡
#
# ====================

# SSH è¿æ¥ (æ˜¾å¼æŒ‡å®šç›®æ ‡ - åªè¯»æ“ä½œ)

[tasks.ssh]
description = "SSH to prod server and cd to /srv"
run = 'ssh -t deploy@YOUR_PROD_SERVER_IP "cd /srv && exec bash -l"'
alias = "ssh-prod"

[tasks.ssh-preview]
description = "SSH to preview server and cd to /srv"
run = 'ssh -t deploy@YOUR_PREVIEW_SERVER_IP "cd /srv && exec bash -l"'

# ç”¨è„šæœ¬åˆ›å»ºåˆå§‹ç”¨æˆ·
[tasks.server-init-user]
description = "Create deploy user on server(s)"
usage = '''
arg "<ip>" var=#true
flag "-u --user <user>" help="admin user" default="root" env="ADMIN_USER"
'''
run = '''
for ip in ${usage_ip?}; do
  rsync -chazP ./scripts/create-init-user.sh ${usage_user?}@$ip:
  ssh ${usage_user?}@$ip 'bash create-init-user.sh'
done
'''


# æœåŠ¡å™¨åˆå§‹åŒ– (æ˜¾å¼æŒ‡å®šç›®æ ‡ - æåº¦å±é™©ï¼Œå¿…é¡»æ‰‹åŠ¨ç¡®è®¤)
# è§„åˆ™: åˆå§‹åŒ–æ“ä½œå¤ªå±é™©ä¸”é¢‘ç‡æä½ï¼Œå¿…é¡»æ˜¾å¼æŒ‡å®šç›®æ ‡ï¼Œä¸è‡ªåŠ¨æ£€æµ‹
[tasks.server-init]
description = "Initialize server(s) - specify target or defaults to all (e.g. mr server-init prod2)"
usage = '''
arg "[target]" help="Server target: prod1, prod2, preview, prod_servers, or all" default="all"
flag "--become" help="Use sudo for privilege escalation (for CI)"
flag "--no-update" help="Skip system update (apt upgrade)"
'''
run = """
TARGET="${usage_target}"
echo "ğŸ¯ Target: $TARGET"

ARGS="-i ansible/inventory.yml ansible/playbooks/init-server.yml"

# é»˜è®¤æ‰§è¡Œç³»ç»Ÿæ›´æ–°ï¼Œé™¤éæŒ‡å®š --no-update
if [ "${usage_no_update}" != "true" ]; then
  ARGS="$ARGS -e force_system_update=true"
fi

# CI ç¯å¢ƒéœ€è¦ --become
if [ "${usage_become}" = "true" ]; then
  ARGS="$ARGS --become"
fi

if [ "$TARGET" != "all" ]; then
  ARGS="$ARGS -l $TARGET"
fi

ansible-playbook $ARGS
"""

# æœåŠ¡å™¨é…ç½®æ›´æ–° (ä¸¥æ ¼åˆ†æ”¯ç»‘å®šï¼Œè·³è¿‡ç³»ç»Ÿæ›´æ–°)
[tasks.server-update]
description = "Update server configuration without system update (auto-detect target)"
run = "bash scripts/server-operation.sh update init-server.yml"

# ç³»ç»ŸåŒ…æ›´æ–° (å•ç‹¬æ‰§è¡Œï¼Œè€—æ—¶è¾ƒé•¿)
[tasks.server-apt-upgrade]
description = "Run apt upgrade on server (slow, auto-detect target)"
run = "bash scripts/server-operation.sh apt-upgrade init-server.yml force_system_update=true"

# åŒæ­¥æœåŠ¡å™¨é…ç½® (ä¸¥æ ¼åˆ†æ”¯ç»‘å®š)
[tasks.sync-config]
description = "Sync server-mise.toml and bash_aliases (auto-detect target: mainâ†’prod, otherâ†’preview)"
run = "bash scripts/server-operation.sh sync-config sync-server-config.yml"

# é…ç½® AWS å‡­è¯ (ä¸¥æ ¼åˆ†æ”¯ç»‘å®š)
[tasks.server-configure-aws]
description = "Configure AWS credentials for ECR access (auto-detect target: mainâ†’prod, otherâ†’preview)"
run = "bash scripts/server-operation.sh configure-aws configure-aws-credentials.yml"

# å¤‡ä»½ä¸æ¢å¤ï¼ˆé€šè¿‡ Ansible è§¦å‘ï¼‰
[tasks.server-backup]
description = "Run backup on prod servers (default: all, or specify prod1/prod2)"
usage = 'arg "[server]" help="Target server: all (default), prod1, prod2" default="all"'
run = "bash scripts/server-operation.sh backup run-backup.yml ${usage_server}"
alias = "backup"

# Volume ç®¡ç† (æ˜¾å¼æŒ‡å®šç›®æ ‡ - å±é™©æ“ä½œ)
[tasks.server-resize-volume-prod]
description = "Resize Hetzner volume on prod server (expand filesystem)"
run = "ansible-playbook -i ansible/inventory.yml ansible/playbooks/resize.yml -l prod"

[tasks.server-resize-volume-preview]
description = "Resize Hetzner volume on preview server (expand filesystem)"
run = "ansible-playbook -i ansible/inventory.yml ansible/playbooks/resize.yml -l preview"

# Docker æ•°æ®æ¸…ç†ï¼ˆç³»ç»Ÿé‡å»ºå‰å¤‡ä»½ï¼‰
[tasks.server-clean-docker]
description = "Clean Docker data (auto-detect environment, move to .old backup before rebuild)"
run = "bash scripts/server-operation.sh clean-docker clean-docker.yml"

# Note: å…¶ä»–æœåŠ¡å™¨è¿ç»´ä»»åŠ¡ï¼ˆæŸ¥çœ‹æ—¥å¿—ã€æ¢å¤æ•°æ®åº“ã€æŸ¥çœ‹å¤‡ä»½ç­‰ï¼‰
# è¯· SSH åˆ°æœåŠ¡å™¨åä½¿ç”¨ server-mise.toml ä¸­å®šä¹‰çš„ä»»åŠ¡
# ä¾‹å¦‚ï¼šmise ssh-studio ç„¶å mise run db-restore-local

# ==================== é€šç”¨å·¥å…· (æ— å‰ç¼€) ====================

[tasks.lint]
description = "Lint all projects"
run = 'pnpm --filter "./js-apps/*" lint'

[tasks.format]
description = "Format code with Prettier"
run = 'prettier --write "**/*.{ts,tsx,md}"'

[tasks.test]
description = "Run tests"
run = 'pnpm --filter "./js-apps/*" test'

[tasks.clean]
description = "Clean build artifacts"
run = 'pnpm --filter "./js-apps/*" clean'

[tasks.install]
description = "Install dependencies"
run = 'pnpm --filter "./js-apps/*" install'

[tasks.build]
description = "Build all projects"
run = 'pnpm --filter "./js-apps/*" build'

[tasks.serve]
description = "Serve built applications"
run = 'pnpm --filter "./js-apps/*" start'

# ==================== è¾…åŠ©å·¥å…· ====================

[tasks.build-db-prepare]
description = "Build db-prepare (prepare migrations)"
run = "bash infra-apps/db-prepare/build.sh"

[tasks.build-psenv]
description = "Build psenv Rust tool"
run = 'cargo build --release'
dir = "rust-packages/psenv"

[tasks.release-psenv]
description = "Publish psenv to crates.io"
run = 'cargo publish'
dir = "rust-packages/psenv"

# ==================== AWS ECR ç®¡ç† ====================

[tasks.ecr-setup-lifecycle]
description = "Setup lifecycle policies for all ECR repositories"
run = "bash scripts/setup-ecr-lifecycle.sh"
alias = "ecr-lifecycle"

# ==================== åŠ¨æ€ä»»åŠ¡ ====================

[tasks.addjs]
description = "Add package to a specific JS project"
usage = '''
arg "<project>"
arg "[packages]" var=#true
'''
run = 'pnpm --filter "./js-apps/${usage_project?}" add ${usage_packages?}'

[tasks.buildjs]
description = "Run custom build command for a JS project"
usage = '''
arg "<project>"
arg "[args]" var=#true
'''
run = 'pnpm --filter "./js-apps/${usage_project?}" ${usage_args?}'

# ==================== é¢„è§ˆç¯å¢ƒç®¡ç† ====================

[tasks.preview-list]
description = "List all preview environments (by branch)"
alias = "previews"
run = "bash scripts/preview-list.sh"

[tasks.preview-delete]
description = "Delete a preview environment by branch name, or a specific project"
run = "bash scripts/preview-delete.sh ${usage_branch:-} ${usage_project:-} ${usage_yes:+--yes}"
usage = '''
arg "<branch>" help="Branch name to delete (e.g., feat-test)"
arg "[project]" help="Optional: specific project to delete (e.g., hono-demo)"
flag "-y --yes" help="Skip confirmation"
'''

[tasks.preview-delete-all]
description = "Delete ALL preview environments"
run = "bash scripts/preview-delete-all.sh ${usage_yes:+--yes}"
usage = '''
flag "-y --yes" help="Skip confirmation"
'''
